server {
  listen ${service['sophon.ui.port']};
  <#if service['server.ssl.enabled'] = "true">
  ssl on;
  ssl_certificate /usr/lib/sophon_web/server.crt;
  ssl_certificate_key /usr/lib/sophon_web/server.key;
  ssl_session_timeout 5m;
  ssl_protocols SSLv2 SSLv3 TLSv1;
  ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
  ssl_prefer_server_ciphers on;
  error_page 497 https://$host:$server_port$request_uri;
  </#if>
  location / {
    root  /usr/lib/sophon_web/build;
    index index.html index.htm;
    try_files $uri $uri/ /index.html;
  }
  error_page  500 502 503 504 /50x.html;
  location = /50x.html {
    root  /usr/lib/sophon_web/build;
  }
  location /gateway/ {
    proxy_pass http://${service.roles.SOPHON_GATEWAY[0].hostname}:${service['gateway.server.port']}/;
    proxy_http_version 1.1;
    <#if service['server.ssl.enabled'] = "true">
    proxy_set_header X-Forwarded-Proto https;
    <#else>
    proxy_set_header X-Forwarded-Proto http;
    </#if>
    proxy_set_header X-Forwarded-For ${service.roles.SOPHON_WEB[0]['ip']};
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host:$server_port;
    proxy_cache_bypass $http_upgrade;
  }
  location ~ ^/(cas|api){
    proxy_pass http://${service.roles.SOPHON_GATEWAY[0].hostname}:${service['gateway.server.port']};
    proxy_http_version 1.1;
    <#if service['server.ssl.enabled'] = "true">
    proxy_set_header X-Forwarded-Proto https;
    <#else>
    proxy_set_header X-Forwarded-Proto http;
    </#if>
    proxy_set_header X-Forwarded-For ${service.roles.SOPHON_BASE[0]['ip']};
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host:$server_port;
    proxy_cache_bypass $http_upgrade;
  }
}
